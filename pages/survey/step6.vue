<template>
	<view class="container">
		<view class="page">
			<view class="survey-content">
				<!-- <view class="title-card title-card-blue">
					<text class="title-text">ç¬¬å››æ­¥ï¼šå¹³é™æŠ€å·§å®è·µ</text>
				</view> -->
				
				<!-- æ”¾æ¾è‚Œè‚‰éƒ¨åˆ† -->
				<view class="technique-section">
					<view class="technique-image-container">
						<image class="technique-image" src="https://tccolumbia.qualtrics.com/CP/Graphic.php?IM=IM_a5k5DdLTpM1Ovbg" mode="widthFix"></image>
					</view>
					
					<view class="technique-content">
						<text class="section-title">å¦‚ä½• <text class="highlight-blue">æ”¾æ¾è‚Œè‚‰</text>ï¼š</text>
						
						<view class="step-container">
							<view class="step-number">
								<text>1</text>
							</view>
							<view class="step-content">
								<text class="step-text">ç‚¹å‡»æ’­æ”¾é”®ï¼Œå¬å¬ä¸“å®¶è®²è§£å¦‚ä½•æ”¾æ¾è‚Œè‚‰ã€‚</text>
							</view>
						</view>
						
						<view class="step-container">
							<view class="step-number">
								<text>2</text>
							</view>
							<view class="step-content">
								<text class="step-text">åœ¨å¬çš„åŒæ—¶ï¼Œå®Œæ•´åœ°è·ŸéšéŸ³é¢‘é‡Œçš„æŒ‡ç¤ºã€‚</text>
							</view>
						</view>
						
						<view class="step-container">
							<view class="step-number">
								<text>3</text>
							</view>
							<view class="step-content">
								<text class="step-text">è·Ÿç€å®Œæˆ8åˆ†é’Ÿçš„ç»ƒä¹ åï¼Œçœ‹çœ‹ä½ æœ‰ä»€ä¹ˆæ ·çš„æ„Ÿè§‰ã€‚</text>
							</view>
						</view>
						
						<view class="step-container">
							<view class="step-number">
								<text>4</text>
							</view>
							<view class="step-content">
								<text class="step-text">ç‚¹å‡»ä¸‹æ–¹æ–‡å­—ä¸‹è½½éŸ³é¢‘ã€‚ä½ å¯ä»¥åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œä½¿ç”¨è¯¥éŸ³é¢‘è‡ªä¸»ç»ƒä¹ æ”¾æ¾è‚Œè‚‰ã€‚</text>
							</view>
						</view>
					</view>
					
					<!-- éŸ³é¢‘æ’­æ”¾å™¨ -->
					<view class="audio-player">
						<view class="audio-controls">
							<view class="play-button" @click="togglePlay">
								<text class="play-icon">{{ isPlaying ? 'âšâš' : 'â–¶' }}</text>
							</view>
							<text class="time-text">{{ currentTimeText }} / 8:25</text>
							<slider class="audio-slider" min="0" max="100" :value="progress" @change="onSliderChange" />
							<view class="volume-control">
								<text class="volume-icon">ğŸ”Š</text>
							</view>
							<view class="more-options">
								<text class="options-icon">â‹®</text>
							</view>
						</view>
					</view>
					
					<view class="audio-title">
						<text>æ”¾æ¾è‚Œè‚‰æŒ‡å¯¼è¯­</text>
					</view>
				</view>
				
				<!-- å¿«é€Ÿå¹³é™éƒ¨åˆ† -->
				<view class="technique-section">
					<view class="technique-image-container">
						<image class="technique-image" src="https://tccolumbia.qualtrics.com/CP/File.php?F=F_d0bXri7zcr4pVJk" mode="widthFix"></image>
					</view>
					
					<view class="technique-content">
						<text class="section-title">ä»€ä¹ˆæ—¶å€™ä½¿ç”¨<text class="highlight-blue">å¿«é€Ÿå¹³é™</text>ï¼š</text>
						<text class="content-text">åœ¨ä½ çªç„¶æ„Ÿåˆ°éå¸¸ä¸å¼€å¿ƒï¼Œå¹¶å¸Œæœ›å¿«é€Ÿè®©è‡ªå·±å¥½è½¬çš„æ—¶å€™ã€‚ä½ å¯èƒ½ååœ¨æ•™å®¤é‡Œå‡†å¤‡å‚åŠ è€ƒè¯•ï¼Œçªç„¶æ„Ÿè§‰å¾ˆä¸å¥½ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå¿«é€Ÿå¹³é™å°±å¯ä»¥å¾ˆå¥½åœ°å¸®åŠ©åˆ°ä½ ã€‚</text>
					</view>
					
					<view class="technique-content">
						<text class="section-title">å¦‚ä½• <text class="highlight-blue">å¿«é€Ÿå¹³é™</text>ï¼š</text>
						
						<view class="step-container">
							<view class="step-number">
								<text>1</text>
							</view>
							<view class="step-content">
								<text class="step-text">ç”¨é¼»å­å¸æ°”ï¼Œå±ä½å‘¼å¸å‡ ç§’é’Ÿã€‚</text>
							</view>
						</view>
						
						<view class="step-container">
							<view class="step-number">
								<text>2</text>
							</view>
							<view class="step-content">
								<text class="step-text">åœ¨å±ä½å‘¼å¸çš„åŒæ—¶ï¼Œæƒ³è±¡è®©ä½ æ„Ÿåˆ°å¹³é™çš„åœºæ™¯ï¼Œå¹¶å°†è¿™ä¸ªç”»é¢ä¿æŒåœ¨è„‘æµ·ä¸­ã€‚</text>
							</view>
						</view>
						
						<view class="step-container">
							<view class="step-number">
								<text>3</text>
							</view>
							<view class="step-content">
								<text class="step-text">æ”¾æ¾èº«ä½“ç´§å¼ çš„éƒ¨ä½ã€‚æ¯”å¦‚ï¼Œå¦‚æœä½ å‘ç°è‡ªå·±æ‹³å¤´ç´§æ¡ï¼Œå°±æ¾å¼€æ‰‹ã€‚</text>
							</view>
						</view>
						
						<view class="step-container">
							<view class="step-number">
								<text>4</text>
							</view>
							<view class="step-content">
								<text class="step-text">å°½å¯èƒ½æ…¢åœ°å‘¼æ°”ï¼ŒåŒæ—¶æƒ³ç€ä½ çš„å®é™åœºæ™¯ï¼Œå¹¶æ”¾æ¾ç´§å¼ çš„èº«ä½“éƒ¨ä½ã€‚</text>
							</view>
						</view>
					</view>
					
					<view class="next-suggestion">
						<text>åœ¨å®é™…ç”Ÿæ´»ä¸­å°è¯•è¿™äº›æŠ€å·§ï¼Œæ‰¾åˆ°æœ€é€‚åˆä½ çš„æ–¹æ³•ï¼</text>
					</view>
				</view>
				
				<view class="navigation">
					<view class="nav-button" @click="goBack">
						<text class="nav-icon">â†</text>
					</view>
					<view class="nav-button final" @click="goNext">
						<text class="nav-icon">â†’</text>
					</view>
				</view>
			</view>
		</view>
	</view>
</template>

<script>
	// ä½œä¸ºå…¨å±€éŸ³é¢‘å®ä¾‹ï¼Œä¸ä¼šåœ¨ç»„ä»¶é”€æ¯æ—¶è¢«é”€æ¯
	let globalAudio = null;
	let progressTimer = null;
	const AUDIO_DURATION = 505; // 8:25 = 505ç§’
	
	export default {
		data() {
			return {
				isPlaying: false,
				progress: 0,
				currentTimeText: '0:00'
			}
		},
		onLoad() {
			console.log("Step6é¡µé¢åŠ è½½");
		},
		onUnload() {
			// åœ¨ç»„ä»¶å¸è½½æ—¶æ¸…ç†è®¡æ—¶å™¨
			this.clearProgressTimer();
		},
		methods: {
			togglePlay() {
				console.log("ç‚¹å‡»æ’­æ”¾æŒ‰é’®ï¼Œå½“å‰çŠ¶æ€:", this.isPlaying);
				
				// å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œåˆ™æš‚åœ
				if (this.isPlaying && globalAudio) {
					console.log("æš‚åœéŸ³é¢‘");
					globalAudio.pause();
					this.isPlaying = false;
					this.clearProgressTimer();
					return;
				}
				
				// å¦‚æœå­˜åœ¨å…¨å±€éŸ³é¢‘ä¸”å·²æš‚åœï¼Œåˆ™ç»§ç»­æ’­æ”¾
				if (globalAudio) {
					console.log("ç»§ç»­æ’­æ”¾å·²å­˜åœ¨çš„éŸ³é¢‘");
					globalAudio.play();
					this.isPlaying = true;
					this.startProgressTimer();
					return;
				}
				
				// å¦‚æœæ²¡æœ‰éŸ³é¢‘å®ä¾‹ï¼Œåˆ™åˆ›å»ºæ–°å®ä¾‹
				try {
					console.log("åˆ›å»ºæ–°éŸ³é¢‘å®ä¾‹");
					globalAudio = wx.createInnerAudioContext();
					globalAudio.src = 'https://tccolumbia.qualtrics.com/CP/File.php?F=F_738nxh0lkZi71vE';
					
					// ç›‘å¬é”™è¯¯
					globalAudio.onError((err) => {
						console.error('éŸ³é¢‘æ’­æ”¾é”™è¯¯:', err);
						this.isPlaying = false;
						this.clearProgressTimer();
						uni.showToast({
							title: 'éŸ³é¢‘æ’­æ”¾å¤±è´¥',
							icon: 'none'
						});
					});
					
					// ç›‘å¬æ’­æ”¾ç»“æŸ
					globalAudio.onEnded(() => {
						console.log('éŸ³é¢‘æ’­æ”¾ç»“æŸ');
						this.isPlaying = false;
						this.clearProgressTimer();
						this.progress = 100; // è®¾ç½®è¿›åº¦æ¡ä¸º100%
						this.currentTimeText = '8:25'; // æ˜¾ç¤ºæ€»æ—¶é•¿
					});
					
					// å¼€å§‹æ’­æ”¾
					globalAudio.play();
					this.isPlaying = true;
					this.startProgressTimer();
				} catch (e) {
					console.error("éŸ³é¢‘æ’­æ”¾å¤±è´¥:", e);
					this.isPlaying = false;
					uni.showToast({
						title: 'éŸ³é¢‘æ’­æ”¾å¤±è´¥',
						icon: 'none'
					});
				}
			},
			startProgressTimer() {
				// æ¸…ç†å·²æœ‰è®¡æ—¶å™¨
				this.clearProgressTimer();
				
				// å¼€å§‹æ–°çš„è®¡æ—¶å™¨
				progressTimer = setInterval(() => {
					if (globalAudio && typeof globalAudio.currentTime === 'number') {
						// è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
						const currentTime = globalAudio.currentTime;
						this.progress = Math.floor((currentTime / AUDIO_DURATION) * 100);
						
						// æ ¼å¼åŒ–å½“å‰æ—¶é—´ä¸ºåˆ†:ç§’
						const minutes = Math.floor(currentTime / 60);
						const seconds = Math.floor(currentTime % 60);
						this.currentTimeText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
						
						console.log(`æ›´æ–°è¿›åº¦: ${this.progress}%, æ—¶é—´: ${this.currentTimeText}`);
					}
				}, 1000); // æ¯ç§’æ›´æ–°ä¸€æ¬¡
			},
			clearProgressTimer() {
				if (progressTimer) {
					clearInterval(progressTimer);
					progressTimer = null;
				}
			},
			onSliderChange(e) {
				// å®ç°è¿›åº¦æ¡æ‹–åŠ¨è·³è½¬åŠŸèƒ½
				if (!globalAudio) {
					console.log("éŸ³é¢‘æœªåˆå§‹åŒ–ï¼Œæ— æ³•è·³è½¬");
					return;
				}
				
				try {
					// è·å–æ»‘å—å€¼ï¼ˆ0-100ï¼‰
					const value = e.detail.value;
					console.log("æ»‘å—å€¼:", value);
					
					// è®¡ç®—å¯¹åº”çš„æ—¶é—´ä½ç½®ï¼ˆç§’ï¼‰
					const seekTime = (value / 100) * AUDIO_DURATION;
					console.log("è·³è½¬åˆ°ä½ç½®:", seekTime, "ç§’");
					
					// è®¾ç½®éŸ³é¢‘æ’­æ”¾ä½ç½®
					globalAudio.seek(seekTime);
					
					// æ›´æ–°æ˜¾ç¤ºçš„æ—¶é—´
					const minutes = Math.floor(seekTime / 60);
					const seconds = Math.floor(seekTime % 60);
					this.currentTimeText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
					
					// å¦‚æœå½“å‰æ²¡æœ‰æ’­æ”¾ï¼Œåˆ™è‡ªåŠ¨å¼€å§‹æ’­æ”¾
					if (!this.isPlaying) {
						console.log("ä»æ–°ä½ç½®å¼€å§‹æ’­æ”¾");
						globalAudio.play();
						this.isPlaying = true;
						this.startProgressTimer();
					}
				} catch (e) {
					console.error("è·³è½¬æ’­æ”¾å¤±è´¥:", e);
					uni.showToast({
						title: 'è·³è½¬å¤±è´¥',
						icon: 'none'
					});
				}
			},
			goBack() {
				// åœ¨ç¦»å¼€é¡µé¢å‰æš‚åœéŸ³é¢‘ä½†ä¸é”€æ¯å®ä¾‹
				if (globalAudio && this.isPlaying) {
					try {
						globalAudio.pause();
						this.clearProgressTimer();
					} catch (e) {
						console.error("æš‚åœéŸ³é¢‘å¤±è´¥:", e);
					}
				}
				uni.navigateBack();
			},
			goNext() {
				// åœ¨ç¦»å¼€é¡µé¢å‰æš‚åœéŸ³é¢‘ä½†ä¸é”€æ¯å®ä¾‹
				if (globalAudio && this.isPlaying) {
					try {
						globalAudio.pause();
						this.clearProgressTimer();
					} catch (e) {
						console.error("æš‚åœéŸ³é¢‘å¤±è´¥:", e);
					}
				}
				uni.navigateTo({
					url: './step7',
					fail: () => {
						// å¦‚æœæ²¡æœ‰step7é¡µé¢ï¼Œåˆ™æ˜¾ç¤ºå®Œæˆæç¤º
						uni.showToast({
							title: 'æ­å–œå®Œæˆæ‰€æœ‰æ­¥éª¤ï¼',
							icon: 'success',
							duration: 2000
						});
					}
				});
			}
		}
	}
</script>

<style>
	.container {
		display: flex;
		flex-direction: column;
		align-items: center;
		width: 100%;
		min-height: 100vh;
		background-color: #ffffff;
		box-sizing: border-box;
	}
	
	.page {
		display: flex;
		flex-direction: column;
		align-items: center;
		width: 100%;
		max-width: 750rpx;
		box-sizing: border-box;
	}
	
	.survey-content {
		width: 100%;
		display: flex;
		flex-direction: column;
		margin-bottom: 20rpx;
		padding: 0 20rpx;
		box-sizing: border-box;
	}
	
	.title-card {
		width: 100%;
		padding: 32rpx 0;
		display: flex;
		justify-content: center;
		align-items: center;
		margin: 30rpx 0 70rpx 0;
		border-radius: 60rpx;
	}
	
	.title-card-blue {
		background-color: #E1F5F7;
	}
	
	.title-text {
		font-size: 38rpx;
		font-weight: bold;
		color: #4E97A0;
		text-align: center;
	}
	
	.technique-section {
		width: 100%;
		margin-bottom: 60rpx;
		box-sizing: border-box;
	}
	
	.technique-image-container {
		width: 100%;
		display: flex;
		justify-content: center;
		margin-bottom: 30rpx;
	}
	
	.technique-image {
		width: 300rpx;
	}
	
	.technique-content {
		padding: 0 30rpx;
		margin-bottom: 40rpx;
	}
	
	.section-title {
		font-size: 36rpx;
		font-weight: bold;
		color: #333;
		margin-bottom: 30rpx;
		display: block;
	}
	
	.highlight-blue {
		background-color: #E1F5F7;
		padding: 2rpx 10rpx;
		border-radius: 6rpx;
	}
	
	.content-text {
		font-size: 32rpx;
		color: #333;
		line-height: 1.8;
		margin: 20rpx 0;
		display: block;
		text-align: justify;
	}
	
	.step-container {
		display: flex;
		margin-bottom: 30rpx;
	}
	
	.step-number {
		width: 60rpx;
		height: 60rpx;
		background-color: #E1F5F7;
		border-radius: 50%;
		display: flex;
		justify-content: center;
		align-items: center;
		margin-right: 20rpx;
	}
	
	.step-number text {
		font-size: 32rpx;
		font-weight: bold;
		color: #4E97A0;
	}
	
	.step-content {
		flex: 1;
	}
	
	.step-text {
		font-size: 32rpx;
		color: #333;
		line-height: 1.6;
	}
	
	.audio-player {
		width: 94%;
		margin: 40rpx auto;
		padding: 20rpx 25rpx;
		background-color: #F5F5F5;
		border-radius: 50rpx;
		box-sizing: border-box;
		box-shadow: 0 2px 8px rgba(0,0,0,0.05);
	}
	
	.audio-controls {
		display: flex;
		align-items: center;
	}
	
	.play-button {
		width: 60rpx;
		height: 60rpx;
		background-color: #e3b878;
		border-radius: 50%;
		display: flex;
		justify-content: center;
		align-items: center;
		margin-right: 20rpx;
	}
	
	.play-icon {
		color: #FFFFFF;
		font-size: 28rpx;
	}
	
	.time-text {
		font-size: 28rpx;
		color: #666;
		margin-right: 20rpx;
		min-width: 120rpx;
	}
	
	.audio-slider {
		flex: 1;
		margin: 0 20rpx;
	}
	
	.volume-control, .more-options {
		width: 60rpx;
		height: 60rpx;
		display: flex;
		justify-content: center;
		align-items: center;
	}
	
	.volume-icon, .options-icon {
		font-size: 28rpx;
		color: #666;
	}
	
	.audio-title {
		width: 100%;
		text-align: center;
		font-size: 34rpx;
		font-weight: bold;
		color: #4E97A0;
		margin: 20rpx 0 50rpx 0;
	}
	
	.next-suggestion {
		width: 100%;
		text-align: center;
		font-size: 32rpx;
		color: #333;
		margin: 40rpx 0 60rpx 0;
	}
	
	.navigation {
		width: 100%;
		display: flex;
		justify-content: space-between;
		margin: 40rpx 0;
		padding: 0 30rpx;
		box-sizing: border-box;
	}
	
	.nav-button {
		width: 80rpx;
		height: 80rpx;
		background-color: #e1f3ef;
		border-radius: 50%;
		display: flex;
		justify-content: center;
		align-items: center;
		box-shadow: 0 2px 5px rgba(0,0,0,0.1);
	}
	
	.nav-button:active {
		opacity: 0.8;
	}
	
	.nav-button.final {
		background-color: #e1f3ef;
	}
	
	.nav-icon {
		font-size: 38rpx;
		color: #333;
	}
	
	@media screen and (min-width: 768px) {
		.page {
			max-width: 960rpx;
		}
	}
</style> 