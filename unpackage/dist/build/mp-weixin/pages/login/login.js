"use strict";const e=require("../../common/vendor.js"),o=require("../../utils/config.js"),n={data:()=>({code:"",showDebug:!1,config:o.config,loading:!1}),onLoad(){this.getWxCode()},methods:{toggleDebug(){this.showDebug=!this.showDebug},checkApiConfig(){console.log("当前API配置:",o.config),e.index.showModal({title:"API配置",content:`当前API地址: ${o.config.api.wxLogin}`,showCancel:!1})},mockLogin(){console.log("执行模拟登录"),e.index.setStorageSync("token","mock_token_123456"),e.index.setStorageSync("userInfo",{openid:"mock_openid_123456",userId:1}),e.index.showToast({title:"模拟登录成功",icon:"success"}),setTimeout((()=>{e.index.switchTab({url:"/pages/index/index",success:()=>{console.log("跳转首页成功")},fail:e=>{console.error("跳转首页失败:",e)}})}),1500)},testServerConnection(){e.index.showLoading({title:"测试连接中..."}),e.index.request({url:o.config.baseUrl,method:"GET",timeout:5e3,success:o=>{e.index.hideLoading(),e.index.showModal({title:"连接测试",content:`服务器连接成功! 状态码: ${o.statusCode}`,showCancel:!1})},fail:o=>{e.index.hideLoading(),e.index.showModal({title:"连接测试",content:`连接失败: ${o.errMsg}`,showCancel:!1})}})},checkWxConfig(){const o=e.index.getSystemInfoSync();console.log("系统信息:",o),e.index.showModal({title:"微信环境信息",content:`操作系统: ${o.platform}\n微信版本: ${o.version}\n系统版本: ${o.system}\n小程序基础库: ${o.SDKVersion}`,showCancel:!1})},debugLoginSuccess(){const o={code:0,msg:"登录成功",data:{token:"debug_token_"+(new Date).getTime(),openid:"debug_openid_"+Math.random().toString(36).substring(2),userId:999}};e.index.setStorageSync("token",o.data.token),e.index.setStorageSync("userInfo",o.data),console.log("调试模式: 保存的登录信息",o.data),e.index.showToast({title:"调试登录成功",icon:"success"}),setTimeout((()=>{e.index.switchTab({url:"/pages/home/home",success:()=>{console.log("跳转到首页成功")},fail:e=>{console.error("跳转到首页失败:",e)}})}),1500)},getWxCode(){e.index.login({provider:"weixin",success:e=>{this.code=e.code,console.log("获取code成功:",this.code)},fail:o=>{console.error("获取code失败:",o),e.index.showToast({title:"获取登录信息失败",icon:"none"})}})},handleGetUserInfo(o){"getUserInfo:ok"===o.detail.errMsg?(this.loading=!0,this.code?this.processLogin(o.detail.userInfo):e.index.login({provider:"weixin",success:e=>{this.code=e.code,console.log("重新获取code成功:",this.code),this.processLogin(o.detail.userInfo)},fail:o=>{console.error("获取code失败:",o),this.loading=!1,e.index.showToast({title:"获取登录信息失败",icon:"none"})}})):e.index.showToast({title:"获取用户信息失败",icon:"none"})},processLogin(n){console.log("开始登录请求，code:",this.code);const s={code:this.code,userInfo:JSON.stringify(n)};console.log("登录请求数据:",s),console.log("登录请求地址:",o.config.baseUrl+"/api/wx/login"),e.index.request({url:o.config.baseUrl+"/api/wx/login",method:"POST",data:s,header:{"Content-Type":"application/json"},success:o=>{if(console.log("登录响应完整数据:",o),200===o.statusCode){const n=o.data;console.log("登录响应数据:",n),0===n.code?(console.log("登录成功, 保存数据:",n.data),e.index.setStorageSync("token",n.data.token),e.index.setStorageSync("userInfo",n.data),e.index.showToast({title:"登录成功",icon:"success"}),setTimeout((()=>{e.index.switchTab({url:"/pages/home/home",success:()=>{console.log("跳转到首页成功")},fail:e=>{console.error("跳转到首页失败:",e)}})}),1500)):(console.error("业务逻辑错误:",n),e.index.showToast({title:n.msg||"登录失败",icon:"none"}))}else console.error("HTTP错误:",o.statusCode),e.index.showToast({title:"服务器响应错误: "+o.statusCode,icon:"none"})},fail:o=>{console.error("请求失败:",o),e.index.showToast({title:"网络请求失败: "+o.errMsg,icon:"none"})},complete:()=>{this.loading=!1}})}}};const s=e._export_sfc(n,[["render",function(o,n,s,t,i,c){return e.e({a:e.o(((...e)=>c.handleGetUserInfo&&c.handleGetUserInfo(...e))),b:i.showDebug},i.showDebug?{c:e.t(i.config.env),d:e.t(i.config.baseUrl),e:e.t(i.code||"未获取"),f:e.o(((...e)=>c.checkApiConfig&&c.checkApiConfig(...e))),g:e.o(((...e)=>c.testServerConnection&&c.testServerConnection(...e))),h:e.o(((...e)=>c.getWxCode&&c.getWxCode(...e))),i:e.o(((...e)=>c.checkWxConfig&&c.checkWxConfig(...e))),j:e.o(((...e)=>c.debugLoginSuccess&&c.debugLoginSuccess(...e))),k:e.o(((...e)=>c.mockLogin&&c.mockLogin(...e)))}:{},{l:e.o(((...e)=>c.toggleDebug&&c.toggleDebug(...e))),m:i.loading},(i.loading,{}))}]]);wx.createPage(s);
