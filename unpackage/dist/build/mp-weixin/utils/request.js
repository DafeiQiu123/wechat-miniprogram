"use strict";const e=require("../common/vendor.js"),t=require("./config.js"),n=[];let o=!1;const i=()=>{0!==n.length||o||(o=!0,e.index.showLoading({title:"加载中...",mask:!0})),n.push(1)},a=()=>{n.pop(),0===n.length&&o&&(o=!1,e.index.hideLoading())},s=n=>(0!==(n={url:"",method:"GET",data:{},header:{"Content-Type":"application/json"},loading:!0,...n}).url.indexOf("http")&&(n.url=t.config.baseUrl+n.url),n=(t=>{const n=e.index.getStorageSync("token");return n&&(t.header={...t.header,Authorization:`Bearer ${n}`}),!1!==t.loading&&i(),t})(n),new Promise(((o,i)=>{e.index.request({...n,success:s=>{try{const i=((n,o)=>{if(!1!==o.loading&&a(),n.statusCode>=200&&n.statusCode<300){const e=n.data;return t.config.enableLog&&console.log("请求成功:",e),e}return 401===n.statusCode?(e.index.removeStorageSync("token"),e.index.removeStorageSync("userInfo"),e.index.showToast({title:"登录已失效，请重新登录",icon:"none",duration:2e3}),setTimeout((()=>{e.index.reLaunch({url:"/pages/login/index"})}),1500),Promise.reject(n)):(e.index.showToast({title:n.data.msg||"请求失败",icon:"none",duration:2e3}),Promise.reject(n))})(s,n);o(i)}catch(r){i(r)}},fail:o=>{((n,o)=>{!1!==o.loading&&a(),e.index.showToast({title:"网络连接失败，请检查网络设置",icon:"none",duration:2e3}),t.config.enableLog&&console.error("请求失败:",n),Promise.reject(n)})(o,n),i(o)}})}))),r=(e,t={},n={})=>s({url:e,method:"GET",data:t,...n}),d=(e,t={},n={})=>s({url:e,method:"POST",data:t,...n}),u={user:{login:e=>d("/api/user/login",e),getUserInfo:()=>r("/api/user/info")},wx:{login:e=>d("/api/wx/login",e)},questionnaire:{getList:e=>r("/api/questionnaire/list",e),getDetail:e=>r(`/api/questionnaire/${e}`),submitAnswer:e=>d("/api/questionnaire/answer",e)}},l={request:s,get:r,post:d,put:(e,t={},n={})=>s({url:e,method:"PUT",data:t,...n}),del:(e,t={},n={})=>s({url:e,method:"DELETE",data:t,...n}),upload:(n,o,s="file",r={},d={})=>{!1!==(d={loading:!0,...d}).loading&&i(),0!==n.indexOf("http")&&(n=t.config.baseUrl+n);const u={},l=e.index.getStorageSync("token");return l&&(u.Authorization=`Bearer ${l}`),new Promise(((t,i)=>{e.index.uploadFile({url:n,filePath:o,name:s,formData:r,header:u,success:n=>{try{!1!==d.loading&&a(),"string"==typeof n.data&&(n.data=JSON.parse(n.data)),n.statusCode>=200&&n.statusCode<300?t(n.data):(e.index.showToast({title:n.data.message||"上传失败",icon:"none",duration:2e3}),i(n))}catch(o){i(o)}},fail:t=>{!1!==d.loading&&a(),e.index.showToast({title:"上传失败，请检查网络设置",icon:"none",duration:2e3}),i(t)}})}))},api:u,submitAnswers:e=>{const t={questionnaireId:e.length>0?e[0].questionnaireId:null,userId:e.length>0?e[0].userId:null,userType:e.length>0?e[0].userType:0,answers:e.map((e=>({questionId:e.questionId,content:e.content}))),timeSpent:0};return d("/api/answer/submit",t)}};exports.request=l;
