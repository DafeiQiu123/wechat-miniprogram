"use strict";const e=require("../common/vendor.js"),o=require("./request.js"),n=o=>{o&&e.index.setStorageSync("userInfo",o)},r=o=>{o&&e.index.setStorageSync("token",o)},t=()=>e.index.getStorageSync("token")||"",s=()=>{e.index.removeStorageSync("userInfo"),e.index.removeStorageSync("token")},a=()=>!!t(),i={saveUserInfo:n,saveToken:r,getUserInfo:()=>e.index.getStorageSync("userInfo")||null,getToken:t,clearUserInfo:s,isLoggedIn:a,wxLogin:()=>new Promise(((t,s)=>{e.index.login({provider:"weixin",success:async e=>{if(e.code)try{const a=await o.request.post("/api/user/wx-login",{code:e.code});a.data&&a.data.token?(r(a.data.token),n(a.data.userInfo),t(a.data)):s(new Error("登录失败，未获取到有效的用户信息"))}catch(a){s(a)}else s(new Error("微信登录失败"))},fail:e=>{s(e)}})})),getUserProfile:()=>new Promise(((r,t)=>{a()?e.index.getUserProfile({desc:"用于完善用户资料",success:async e=>{try{const s=await o.request.post("/api/user/update-profile",{userInfo:e.userInfo});s.data&&s.data.userInfo?(n(s.data.userInfo),r(s.data.userInfo)):t(new Error("获取用户信息失败"))}catch(s){t(s)}},fail:e=>{t(e)}}):t(new Error("用户未登录"))})),logout:()=>new Promise((e=>{s(),e()})),checkLogin:o=>!!a()||(e.index.navigateTo({url:"/pages/login/login"+(o?`?redirect=${encodeURIComponent(o)}`:"")}),!1)};exports.auth=i;
